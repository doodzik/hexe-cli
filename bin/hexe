#!/usr/bin/env node

var _ = require('lodash')

var argv = require('optimist').argv;
var fs = require('fs');
var when = require('when');
var nodefn = require('when/node');
var hexeObjPath = process.cwd()+'/.hexe'

when().then(function(){
  return nodefn.call(fs.readFile, hexeObjPath).then(function(data){
    return JSON.parse(data);
  }, function(){
    return {};
  })
})
.then(function(hexeObj){
  var getNewHexObj = require(__dirname + '/../contracts/cli.js')
  var newHexeObj = getNewHexObj(argv, _.cloneDeep(hexeObj))
  return [
     hexeObj,
     newHexeObj
  ];
})
.spread(function(hexeObj, newHexeObj){
  if(hexeObj !== newHexeObj){
    var newHexObj = JSON.stringify(newHexeObj);
    nodefn.call(fs.writeFile, hexeObjPath, newHexObj).done()
  }
  console.log('HEX!HEX!');
})
.catch(function(err){
  if(argv.trace){throw err}
  console.log(err);
})
.done();
