#!/usr/bin/env node

var _ = require('lodash')

var argv = require('optimist').argv;
var fs = require('fs');
var when = require('when');
var nodefn = require('when/node');
var hexeObjPath = process.cwd()+'/.hexe'
var isNew = true

when().then(function(){
  return nodefn.call(fs.readFile, hexeObjPath).then(function(data){
    return JSON.parse(data)
  }, function(){
    isNew = true
    return {}
  })
})
.then(function(hexeObj){
  var getNewHexObj = require(__dirname + '/../contracts/cli.js')
  var newHexeObj = getNewHexObj(argv, _.cloneDeep(hexeObj))
  return [
     hexeObj,
     newHexeObj
  ];
})
.spread(function(hexeObj, newHexeObj){
  if(hexeObj !== newHexeObj){
    if(isNew){
      hexeObjPath = process.cwd()+'/'+ newHexeObj.Service +'/.hexe'
    }
    var newHexObj = JSON.stringify(newHexeObj);
    nodefn.call(fs.writeFile, hexeObjPath, newHexObj).done()
  }
})
.catch(function(err){
  if(argv.trace){throw err}
  console.log(err);
})
.done();
